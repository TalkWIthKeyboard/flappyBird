var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},BackgroundImage=function(t){function e(e){var i=t.call(this)||this;return i.measured=e,i.addimg(),i.addChild(i.imagedata),i}return __extends(e,t),e.prototype.searchImg=function(){var t=parseInt(String(2*Math.random()+1));switch(t){case 2:this.img="bg_day_png";break;case 1:this.img="bg_night_png"}},e.prototype.addimg=function(){this.searchImg(),this.imagedata=new egret.Bitmap(RES.getRes(this.img)),this.imagedata.width=this.measured.stageW,this.imagedata.height=this.measured.stageH},e}(egret.DisplayObjectContainer);__reflect(BackgroundImage.prototype,"BackgroundImage");var Bird=function(t){function e(e,i){var o=t.call(this)||this,r=RES.getRes("bird_json"),s=RES.getRes("bird_png");if(o.mcf=new egret.MovieClipDataFactory(r,s),o.mcf.enableCache=!0,o.addBird(),o.addChild(o.mc),o.mc.x=(e.measured.stageW-o.mc.width)/2-90,o.mc.y=e.measured.stageH/2-80,o.mc.play(-1),i){o.birdBox=new p2.Body({mass:1,position:[o.mc.x+o.mc.width/2,o.mc.y+o.mc.height/2]});var a=new p2.Box({width:o.mc.width,height:o.mc.height});o.birdBox.addShape(a),e.world.addBody(o.birdBox),setInterval(function(){o.mc.x=o.birdBox.position[0]-o.mc.width/2,o.mc.y=o.birdBox.position[1]-o.mc.height/2,o.mc.rotation=360-180*o.birdBox.angle/Math.PI},1e3/60)}else egret.Tween.get(o.mc,{loop:!0}).to({y:e.measured.stageH/2-60},800).to({y:e.measured.stageH/2-80},800);return o}return __extends(e,t),e.prototype.addBird=function(){var t=parseInt(String(2*Math.random()+1));switch(t){case 1:this.mcValue="one";break;case 2:this.mcValue="two";break;case 3:this.mcValue="three"}this.mc=new egret.MovieClip(this.mcf.generateMovieClipData(this.mcValue))},e.prototype.jump=function(){p2.vec2.add(this.birdBox.force,this.birdBox.force,p2.vec2.fromValues(0,-400))},e.prototype.getBirdBox=function(){return this.birdBox},e.prototype.removeBird=function(t){t.world.removeBody(this.birdBox),this.parent.removeChild(this)},e}(egret.DisplayObjectContainer);__reflect(Bird.prototype,"Bird");var Column=function(t){function e(e){var i=t.call(this)||this;i.measured=e.measured,i.co1=new egret.Bitmap(RES.getRes("pipe_down_png")),i.co1.scaleY=1.15,i.addChild(i.co1);var o=parseInt(String(Math.random()*i.co1.height)),r=Math.min(i.measured.stageH/6*5-o-200,i.co1.height);i.co1.y=o-i.co1.height,i.co1.x=i.measured.stageW,i.coBox1=new p2.Body({position:[i.co1.x+i.co1.width/2,o/2]});var s=new p2.Box({width:i.co1.width,height:o});i.coBox1.addShape(s),e.world.addBody(i.coBox1),i.co2=new egret.Bitmap(RES.getRes("pipe_up_png")),i.addChild(i.co2),i.co2.scaleY=1.15,i.co2.y=i.measured.stageH/6*5-r,i.co2.x=i.measured.stageW,i.coBox2=new p2.Body({position:[i.co2.x+i.co2.width/2,i.co2.y+r/2]});var a=new p2.Box({width:i.co2.width,height:r});return i.coBox2.addShape(a),e.world.addBody(i.coBox2),i.timer=new egret.Timer(100,0),i.timer.addEventListener(egret.TimerEvent.TIMER,i.start,i),i.timer.start(),i}return __extends(e,t),e.prototype.start=function(){egret.Tween.get(this.co2).to({x:this.co2.x-20},120),egret.Tween.get(this.co1).to({x:this.co1.x-20},120),this.coBox2.position[0]=this.co2.x,this.coBox1.position[0]=this.co1.x},e.prototype.stop=function(){egret.Tween.removeTweens(this),this.timer.reset()},e.prototype.remove=function(t){t.world.removeBody(this.coBox1),t.world.removeBody(this.coBox2),this.parent.removeChild(this)},e.prototype.timeStart=function(){this.timer.start()},e.prototype.timeEnd=function(){this.timer.reset()},e}(egret.DisplayObjectContainer);__reflect(Column.prototype,"Column");var Floor=function(t){function e(e){var i=t.call(this)||this,o=e.measured;i.measured=o,i.imagedata0=new egret.Bitmap(RES.getRes("land_png")),i.imagedata0.width=o.stageW+10,i.imagedata0.height=o.stageH/6,i.imagedata0.anchorOffsetY=i.imagedata0.height,i.imagedata0.anchorOffsetX=i.imagedata0.width,i.imagedata0.y=o.stageH,i.imagedata0.x=0,i.imagedata1=new egret.Bitmap(RES.getRes("land_png")),i.imagedata1.width=o.stageW+10,i.imagedata1.height=o.stageH/6,i.imagedata1.anchorOffsetY=i.imagedata1.height,i.imagedata1.anchorOffsetX=i.imagedata1.width,i.imagedata1.y=o.stageH,i.imagedata1.x=o.stageW+10;var r=new p2.Plane;return i.floorBox=new p2.Body,i.floorBox.position[1]=o.stageH/6*5,i.floorBox.angle=Math.PI,i.floorBox.addShape(r),e.world.addBody(i.floorBox),i.timer=new egret.Timer(100,0),i.timer.addEventListener(egret.TimerEvent.TIMER,i.start,i),i.addChildAt(i.imagedata0,2),i.addChildAt(i.imagedata1,2),i.timer.start(),i}return __extends(e,t),e.prototype.start=function(){this.imagedata0.x<=0&&(this.imagedata0.x=this.imagedata1.x+this.measured.stageW+10),this.imagedata1.x<=0&&(this.imagedata1.x=this.imagedata0.x+this.measured.stageW+10),egret.Tween.get(this.imagedata0).to({x:this.imagedata0.x-20},100),egret.Tween.get(this.imagedata1).to({x:this.imagedata1.x-20},100)},e.prototype.remove=function(t){t.world.removeBody(this.floorBox),this.parent.removeChild(this)},e.prototype.end=function(){egret.Tween.removeTweens(this),this.timer.reset()},e}(egret.DisplayObjectContainer);__reflect(Floor.prototype,"Floor");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){var i=Math.floor(t/e*100);this.textField.text=i.toString()+" %"},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.hasWorld=!1,e.bestScore=0,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){this.scoreImg=new Score(this,0,this.score),this.lastScoreImg=new Score(this,1,this.score),this.bestScoreImg=new Score(this,2,this.bestScore),this.init()},e.prototype.init=function(){var t=this;this.measured={stageW:this.stage.stageWidth,stageH:this.stage.stageHeight},this.columnIndex=0,this.score=0,this.scoreImg.makeNumberImg(this.score);var e=new Bird(this,!1),i=this.makeBitMap("text_ready_png",0,-100,1.4,1.4),o=this.makeBitMap("tutorial_png",0,0,1,1);o.touchEnabled=!0,this.addChildAt(o,1),this.addChildAt(i,1),this.addChildAt(e,1),o.addEventListener(egret.TouchEvent.TOUCH_TAP,function(r){t.removeChild(i),t.removeChild(o),t.removeChild(e),t.startGame()},this),this.hasWorld||(this.createWorld(),setInterval(function(){t.world.step(.06)})),this.backGourd=new BackgroundImage(this.measured),this.addChildAt(this.backGourd,0),this.floor=new Floor(this),this.addChildAt(this.floor,3)},e.prototype.createWorld=function(){var t=new p2.World;t.sleepMode=p2.World.BODY_SLEEPING,t.gravity=[0,3],this.world=t,this.hasWorld=!0},e.prototype.startGame=function(){var t=this;this.bird=new Bird(this,!0),this.addChildAt(this.bird,5),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.bird.jump,this.bird),this.birdBoxId=this.bird.getBirdBox().id,this.world.on("beginContact",this.onBeginContact,this),this.addAndDeleteColumn(this),this.scoreTimer=new egret.Timer(100,0),this.scoreTimer.addEventListener(egret.TimerEvent.TIMER,function(){t.bird.mc.x>t.columnList[t.columnIndex].co2.x&&(t.columnIndex++,t.score++,t.scoreImg.makeNumberImg(t.score)),t.bird.mc.y<0&&t.stopGame()},this),this.scoreTimer.start()},e.prototype.addAndDeleteColumn=function(t){var e=this;this.columnList=[],this.columnTimer=new egret.Timer(100,0),this.columnTimer.addEventListener(egret.TimerEvent.TIMER,function(){var t=e.columnList.length;if(0==t||e.columnList[t-1].co2.x<e.measured.stageW-200){var i=new Column(e);e.addChildAt(i,1),e.columnList.push(i),t++}e.columnList[0].x+e.columnList[0].width<=0&&(e.columnList[0].remove(),e.columnList.shift(),e.columnIndex--)},t),this.columnTimer.start()},e.prototype.stopGame=function(){var t=this;this.bestScore=this.score>this.bestScore?this.score:this.bestScore,this.floor.end(),this.columnTimer.reset(),this.scoreTimer.reset(),this.columnList.forEach(function(t){t.timeEnd()}),this.bird.removeBird(this),this.world.off("beginContact",null),this.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.bird.jump,this.bird);var e=this.makeBitMap("text_game_over_png",0,-200,1.4,1.4),i=this.makeBitMap("score_panel_png",0,0,1.6,1.6),o=this.makeBitMap("button_play_png",0,200,1.4,1.4);this.scoreImg.clearNumber(),this.lastScoreImg.makeNumberImg(this.score),this.bestScoreImg.makeNumberImg(this.bestScore),o.touchEnabled=!0,this.addChildAt(e,3),this.addChildAt(i,3),this.addChildAt(o,3),o.addEventListener(egret.TouchEvent.TOUCH_TAP,function(r){t.removeChild(e),t.removeChild(t.backGourd),t.removeChild(i),t.removeChild(o),t.floor.remove(t),t.lastScoreImg.clearNumber(),t.bestScoreImg.clearNumber();for(var s=0;s<t.columnList.length;s++)t.columnList[s].remove(t);t.init()},this)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,o=t.map(function(t){return i.parse(t)}),r=this.textfield,s=-1,a=function(){s++,s>=o.length&&(s=0);var t=o[s];r.textFlow=t;var i=egret.Tween.get(r);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(a,e)};a()},e.prototype.onBeginContact=function(t){var e=t.bodyA,i=t.bodyB;(e.id==this.birdBoxId||i.id==this.birdBoxId)&&this.stopGame()},e.prototype.makeBitMap=function(t,e,i,o,r){var s=this.createBitmapByName(t);return s.x=this.measured.stageW/2+e,s.y=this.measured.stageH/2+i,s.scaleX=o,s.scaleY=r,s.anchorOffsetX=s.width/2,s.anchorOffsetY=s.height/2,s},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Score=function(t){function e(e,i,o){var r=t.call(this)||this;return r.scoreImgList=[],r.position=[{x:0,y:-200,sx:1.4,sy:1.4,t:8},{x:120,y:-25,sx:1,sy:1,t:4},{x:120,y:40,sx:1,sy:1,t:4}],r.main=e,r.score=o,r.type=i,r}return __extends(e,t),e.prototype.makeNumberImg=function(t){this.score=t;var e=this.score,i=this.position[this.type],o=0==e?[0]:[];for(this.live&&this.clearNumber();0!=e;)o.push(e%10),e=Math.floor(e/10);for(var r=o.length-1;r>=0;r--)this.scoreImgList.push(this.main.makeBitMap("font_"+o[r]+"_png",i.x,i.y,i.sx,i.sy));switch(o.length){case 2:this.scoreImgList[0].x=this.scoreImgList[0].x-this.scoreImgList[0].width/2-i.t,this.scoreImgList[1].x=this.scoreImgList[1].x+this.scoreImgList[1].width/2+i.t;break;case 3:this.scoreImgList[0].x=this.scoreImgList[0].x-this.scoreImgList[0].width-2*i.t,this.scoreImgList[2].x=this.scoreImgList[2].x+this.scoreImgList[0].width+2*i.t}for(var r=0;r<this.scoreImgList.length;r++)this.main.addChildAt(this.scoreImgList[r],4);this.live=!0},e.prototype.clearNumber=function(){for(var t=0;t<this.scoreImgList.length;t++)this.main.removeChild(this.scoreImgList[t]);this.scoreImgList=[],this.live=!1},e}(egret.DisplayObjectContainer);__reflect(Score.prototype,"Score");