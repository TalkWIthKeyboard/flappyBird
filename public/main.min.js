var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Floor=function(t){function e(e){var i=t.call(this)||this,r=e.measured;i.measured=r,i.imagedata0=new egret.Bitmap(RES.getRes("land_png")),i.imagedata0.width=r.stageW+10,i.imagedata0.height=r.stageH/6,i.imagedata0.anchorOffsetY=i.imagedata0.height,i.imagedata0.anchorOffsetX=i.imagedata0.width,i.imagedata0.y=r.stageH,i.imagedata0.x=0,i.imagedata1=new egret.Bitmap(RES.getRes("land_png")),i.imagedata1.width=r.stageW+10,i.imagedata1.height=r.stageH/6,i.imagedata1.anchorOffsetY=i.imagedata1.height,i.imagedata1.anchorOffsetX=i.imagedata1.width,i.imagedata1.y=r.stageH,i.imagedata1.x=r.stageW+10;var s=new p2.Plane;return i.floorBox=new p2.Body,i.floorBox.position[1]=r.stageH/6*5,i.floorBox.angle=Math.PI,i.floorBox.addShape(s),e.world.addBody(i.floorBox),i.timer=new egret.Timer(100,0),i.timer.addEventListener(egret.TimerEvent.TIMER,i.start,i),i.addChildAt(i.imagedata0,2),i.addChildAt(i.imagedata1,2),i.timer.start(),i}return __extends(e,t),e.prototype.start=function(){this.imagedata0.x<=0&&(this.imagedata0.x=this.imagedata1.x+this.measured.stageW+10),this.imagedata1.x<=0&&(this.imagedata1.x=this.imagedata0.x+this.measured.stageW+10),egret.Tween.get(this.imagedata0).to({x:this.imagedata0.x-20},100),egret.Tween.get(this.imagedata1).to({x:this.imagedata1.x-20},100)},e.prototype.remove=function(t){t.world.removeBody(this.floorBox),this.parent.removeChild(this)},e.prototype.end=function(){egret.Tween.removeTweens(this),this.timer.reset()},e}(egret.DisplayObjectContainer);__reflect(Floor.prototype,"Floor");var BackgroundImage=function(t){function e(e){var i=t.call(this)||this;return i.measured=e,i.addimg(),i.addChild(i.imagedata),i}return __extends(e,t),e.prototype.searchImg=function(){var t=parseInt(String(2*Math.random()+1));switch(t){case 2:this.img="bg_day_png";break;case 1:this.img="bg_night_png"}},e.prototype.addimg=function(){this.searchImg(),this.imagedata=new egret.Bitmap(RES.getRes(this.img)),this.imagedata.width=this.measured.stageW,this.imagedata.height=this.measured.stageH},e}(egret.DisplayObjectContainer);__reflect(BackgroundImage.prototype,"BackgroundImage");var Birds=function(){function t(t,e){this.birdMap=new Map,this.birdList=[],this.main=t;for(var i=0;i<e.length-1;i++){var r=e[i].num,s=parseFloat(e[i].x),o=parseFloat(e[i].y),n=new Bird(t,s,o,r,e[i].name,1);n.alpha=.5,t.addChildAt(n,1),this.birdList.push(r),this.birdMap.set(r,n)}}return t.prototype.birdListDelete=function(t){for(var e=0;e<this.birdList.length;e++)if(this.birdList[e]===t){this.birdList.splice(e,1);break}},t.prototype.removeAll=function(){for(var t=0;t<this.birdList.length;t++)this.removeBird(this.birdList[t],!1);this.birdList=[]},t.prototype.removeBird=function(t,e){if(this.birdMap.has(t)){this.birdMap.get(t);this.birdMap.get(t).removeBird(this.main),this.birdMap["delete"](t),e&&this.birdListDelete(t)}},t.prototype.addBird=function(t){var e=new Bird(this.main,t.x,t.y,t.num,t.name,1);e.alpha=.5,this.main.addChildAt(e,1),this.birdMap.set(t.num,e),this.birdList.push(t.num)},t.prototype.changePosition=function(t){for(var e=t.length,i=0;e>i;i++)if(this.main.bird.id!==t[i].num){var r=t[i].num,s=parseFloat(t[i].y);if(this.birdMap.has(r)){var o=this.birdMap.get(r);egret.Tween.get(o.arrow).to({y:s-10},115),egret.Tween.get(o.text).to({y:s-30},115),egret.Tween.get(o.mc).to({y:s},115)}}},t}();__reflect(Birds.prototype,"Birds");var Column=function(t){function e(e,i,r){var s=t.call(this)||this;s.measured=e.measured,s.co1=new egret.Bitmap(RES.getRes("pipe_down_png")),s.co1.scaleY=1.15,s.addChild(s.co1);var o=i,n=Math.min(s.measured.stageH/6*5-o-300,s.co1.height);s.co1.y=o-s.co1.height,s.co1.x=r,s.coBox1=new p2.Body({position:[s.co1.x+s.co1.width/2,o/2]});var a=new p2.Box({width:s.co1.width,height:o});s.coBox1.addShape(a),e.world.addBody(s.coBox1),s.co2=new egret.Bitmap(RES.getRes("pipe_up_png")),s.addChild(s.co2),s.co2.scaleY=1.15,s.co2.y=s.measured.stageH/6*5-n,s.co2.x=r,s.coBox2=new p2.Body({position:[s.co2.x+s.co2.width/2,s.co2.y+n/2]});var h=new p2.Box({width:s.co2.width,height:n});return s.coBox2.addShape(h),e.world.addBody(s.coBox2),s.timer=new egret.Timer(100,0),s.timer.addEventListener(egret.TimerEvent.TIMER,s.start,s),s.timer.start(),s}return __extends(e,t),e.prototype.start=function(){egret.Tween.get(this.co2).to({x:this.co2.x-20},120),egret.Tween.get(this.co1).to({x:this.co1.x-20},120),this.coBox2.position[0]=this.co2.x,this.coBox1.position[0]=this.co1.x},e.prototype.stop=function(){egret.Tween.removeTweens(this),this.timer.reset()},e.prototype.remove=function(t){t.world.removeBody(this.coBox1),t.world.removeBody(this.coBox2),this.parent.removeChild(this)},e.prototype.timeStart=function(){this.timer.start()},e.prototype.timeEnd=function(){this.timer.reset()},e}(egret.DisplayObjectContainer);__reflect(Column.prototype,"Column");var Columns=function(){function t(t){this.columnMap=new Map,this.numberList=[],this.main=t,this.first=!0}return t.prototype.numberListDelete=function(t){for(var e=0;e<this.numberList.length;e++)if(this.numberList[e]===t){this.numberList.splice(e,1);break}},t.prototype.push=function(t){for(var e=new Set,i=0;i<t.length;i++)e.add(t[i].number);for(var i=0;i<this.numberList.length;i++)!e.has(this.numberList[i])&&this.numberList.length>0&&(this.columnMap.get(this.numberList[i]).remove(this.main),this.columnMap["delete"](this.numberList[i]),this.numberListDelete(this.numberList[i]));for(var i=0;i<t.length;i++){var r=t[i];if(!this.columnMap.has(r.number)&&parseFloat(r.x)>300){var s=new Column(this.main,parseFloat(r.high),parseFloat(r.x));this.main.addChildAt(s,1),this.columnMap.set(r.number,s),this.numberList.push(r.number),this.first&&(this.main.columnIndex=r.number),this.first=!1}}},t.prototype.clear=function(){for(var t=0;t<this.numberList.length;t++)this.columnMap.get(this.numberList[t]).remove(this.main),this.columnMap["delete"](this.numberList[t]);this.numberList=[]},t}();__reflect(Columns.prototype,"Columns");var Bird=function(t){function e(e,i,r,s,o,n){var a=t.call(this)||this;a.arrow=null;var h=RES.getRes("bird_json"),d=RES.getRes("bird_png");switch(a.main=e,a.birdName=o,a.mcf=new egret.MovieClipDataFactory(h,d),a.mcf.enableCache=!0,a.addBird(),a.addChild(a.mc),a.mc.x=i,a.mc.play(-1),a.type=n,n){case 0:a.mc.y=e.measured.stageH/2-80,egret.Tween.get(a.mc,{loop:!0}).to({y:e.measured.stageH/2-60},800).to({y:e.measured.stageH/2-80},800);break;case 1:a.createArrowAndText(i,r,1),a.mc.y=r;break;case 2:a.createArrowAndText(i,r,2),a.id=s,a.mc.y=r,a.birdBox=new p2.Body({mass:1,position:[a.mc.x+a.mc.width/2,a.mc.y+a.mc.height/2]});var c=new p2.Box({width:a.mc.width,height:a.mc.height});a.birdBox.addShape(c),e.world.addBody(a.birdBox),e.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,a.jump,a),setInterval(function(){a.mc.y=a.birdBox.position[1]-a.mc.height/2,a.arrow&&(a.arrow.y=a.mc.y-10,a.text.y=a.mc.y-30)},1e3/60)}return a}return __extends(e,t),e.prototype.addBird=function(){var t=parseInt(String(2*Math.random()+1));switch(t){case 1:this.mcValue="one";break;case 2:this.mcValue="two";break;case 3:this.mcValue="three"}this.mc=new egret.MovieClip(this.mcf.generateMovieClipData(this.mcValue))},e.prototype.jump=function(){p2.vec2.add(this.birdBox.force,this.birdBox.force,p2.vec2.fromValues(0,-400))},e.prototype.getBirdBox=function(){return 2===this.type?this.birdBox:null},e.prototype.createArrowAndText=function(t,e,i){this.text=new egret.TextField,this.text.text=this.birdName,this.text.textColor=16777215,this.text.x=t,this.text.y=e-30,this.arrow=new egret.Bitmap(RES.getRes("arrow_png")),this.arrow.x=t,this.arrow.y=e-10,1===i&&(this.arrow.alpha=.5,this.text.textColor=13421772),this.main.addChild(this.text),this.main.addChild(this.arrow)},e.prototype.removeBird=function(t){2===this.type&&(t.world.removeBody(this.birdBox),this.main.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.jump,this)),this.main.removeChild(this.text),this.main.removeChild(this.arrow),this.parent.removeChild(this)},e}(egret.DisplayObjectContainer);__reflect(Bird.prototype,"Bird");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){var i=Math.floor(t/e*100);this.textField.text=i.toString()+" %"},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.hasWorld=!1,e.bestScore=0,e.columns=void 0,e.columnOpen=!1,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){this.scoreImg=new Score(this,0,this.score),this.lastScoreImg=new Score(this,1,this.score),this.bestScoreImg=new Score(this,2,this.bestScore),this.init()},e.prototype.init=function(){var t=this;this.measured={stageW:this.stage.stageWidth,stageH:this.stage.stageHeight};var e=new Bird(this,0,0,0,null,0),i=this.makeBitMap("text_ready_png",0,-100,1.4,1.4),r=this.makeBitMap("tutorial_png",0,0,1,1);r.touchEnabled=!0,this.addChildAt(r,1),this.addChildAt(i,1),this.addChildAt(e,1),r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(s){t.birdName=t.textInput.input.text,""!==t.birdName&&"输入名字"!==t.birdName&&t.birdName.length<=8?(t.removeChild(i),t.removeChild(r),t.removeChild(e),t.textInput.remove(),t.websocket=new Websocket(t,t.birdName)):alert("请先输入名字哦！名字长度不得超过8！")},this),this.hasWorld||(this.createWorld(),this.textInput=new TextInput(this,"输入名字","INPUT",30,240,0,430),setInterval(function(){t.world.step(.06)})),this.backGourd=new BackgroundImage(this.measured),this.addChildAt(this.backGourd,0),this.floor=new Floor(this),this.addChildAt(this.floor,3)},e.prototype.createWorld=function(){var t=new p2.World;t.sleepMode=p2.World.BODY_SLEEPING,t.gravity=[0,3],this.world=t,this.hasWorld=!0},e.prototype.startGame=function(t){var e=this;this.columnIndex=-1,this.score=0,this.scoreImg.makeNumberImg(this.score),this.columnOpen=!0,this.columns=new Columns(this);var i=t.length;this.bird=new Bird(this,t[i-1].x,t[i-1].y,t[i-1].num,t[i-1].name,2),this.addChildAt(this.bird,1),this.birdMap=new Birds(this,t),this.world.on("beginContact",this.onBeginContact,this),this.scoreTimer=new egret.Timer(100,0),this.scoreTimer.addEventListener(egret.TimerEvent.TIMER,function(){-1!==e.columnIndex&&e.columns&&e.columns.columnMap.get(e.columnIndex.toString())&&e.bird.mc.x>e.columns.columnMap.get(e.columnIndex.toString()).co2.x&&(e.columnIndex=(parseInt(e.columnIndex)+1)%100,e.score++,e.scoreImg.makeNumberImg(e.score)),e.bird.mc.y<0&&e.stopGame(),e.websocket.sendMessage("high,"+e.bird.id+","+e.bird.mc.y)},this),this.scoreTimer.start()},e.prototype.stopGame=function(){var t=this;this.birdMap.removeAll(),this.bird.removeBird(this),this.columnOpen=!1,this.columns.clear(),this.columns=void 0,this.websocket.sendMessage("dead,"+this.bird.id+","+this.bird.birdName+","+this.score),this.bestScore=this.score>this.bestScore?this.score:this.bestScore,this.floor.end(),this.scoreTimer.reset(),this.world.off("beginContact",null);var e=this.makeBitMap("text_game_over_png",0,-260,1.4,1.4),i=this.makeBitMap("score_panel_2_png",0,50,1.6,1.6),r=this.makeBitMap("button_play_png",0,200,1.4,1.4);this.scoreImg.clearNumber(),r.touchEnabled=!0,this.addChildAt(e,3),this.addChildAt(i,2),this.addChildAt(r,3),r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(s){t.removeChild(e),t.removeChild(i),t.removeChild(r),t.floor.start(),t.lastScoreImg.clearNumber(),t.bestScoreImg.clearNumber(),t.websocket.onSocketOpen()},this)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,r=t.map(function(t){return i.parse(t)}),s=this.textfield,o=-1,n=function(){o++,o>=r.length&&(o=0);var t=r[o];s.textFlow=t;var i=egret.Tween.get(s);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(n,e)};n()},e.prototype.onBeginContact=function(t){var e=t.bodyA,i=t.bodyB;(e.id===this.bird.getBirdBox().id||i.id===this.bird.getBirdBox().id)&&this.stopGame()},e.prototype.makeBitMap=function(t,e,i,r,s){var o=this.createBitmapByName(t);return o.x=this.measured.stageW/2+e,o.y=this.measured.stageH/2+i,o.scaleX=r,o.scaleY=s,o.anchorOffsetX=o.width/2,o.anchorOffsetY=o.height/2,o},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Score=function(t){function e(e,i,r){var s=t.call(this)||this;return s.scoreImgList=[],s.position=[{x:0,y:-200,sx:1.4,sy:1.4,t:8},{x:120,y:-25,sx:1,sy:1,t:4},{x:120,y:40,sx:1,sy:1,t:4}],s.main=e,s.score=r,s.type=i,s.live=!1,s}return __extends(e,t),e.prototype.makeNumberImg=function(t){this.score=t;var e=this.score,i=this.position[this.type],r=0==e?[0]:[];for(this.live&&this.clearNumber();0!=e;)r.push(e%10),e=Math.floor(e/10);for(var s=r.length-1;s>=0;s--)this.scoreImgList.push(this.main.makeBitMap("font_"+r[s]+"_png",i.x,i.y,i.sx,i.sy));switch(r.length){case 2:this.scoreImgList[0].x=this.scoreImgList[0].x-this.scoreImgList[0].width/2-i.t,this.scoreImgList[1].x=this.scoreImgList[1].x+this.scoreImgList[1].width/2+i.t;break;case 3:this.scoreImgList[0].x=this.scoreImgList[0].x-this.scoreImgList[0].width-2*i.t,this.scoreImgList[2].x=this.scoreImgList[2].x+this.scoreImgList[0].width+2*i.t}for(var s=0;s<this.scoreImgList.length;s++)this.main.addChildAt(this.scoreImgList[s],3);this.live=!0},e.prototype.clearNumber=function(){for(var t=0;t<this.scoreImgList.length;t++)this.main.removeChild(this.scoreImgList[t]);this.scoreImgList=[],this.live=!1},e}(egret.DisplayObjectContainer);__reflect(Score.prototype,"Score");var TextInput=function(){function t(t,e,i,r,s,o,n){this.main=t;var a=new egret.TextField;a.text=e,a.width=s,a.height=r,a.x=0==o?this.main.measured.stageW/2-a.width/2:o,a.y=n,a.border=!0,a.borderColor=16777215,"INPUT"===i?(a.type=egret.TextFieldType.INPUT,a.textAlign=egret.HorizontalAlign.CENTER):(a.border=!1,a.textColor=0),this.input=a,this.main.addChildAt(this.input,3)}return t.prototype.remove=function(){this.main.removeChild(this.input)},t}();__reflect(TextInput.prototype,"TextInput");var Websocket=function(){function t(t,e){this.numList=[0],this._main=t,this.name=e,this._socket=new egret.WebSocket,this._socket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this._socket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this._socket.connectByUrl("ws://115.159.1.222:5500/")}return t.prototype.workForColumnString=function(t){for(var e=t.split("?"),i=[],r=0;r<e.length-1;r++){var s=e[r].split("/"),o=s[0],n=s[1],a=s[2],h={number:o,high:n,x:a};i.push(h)}return i},t.prototype.onReceiveMessage=function(t){var e=this._socket.readUTF(),i=e.split(",");switch(i[0]){case"start":if("0"===i[1]){for(var r=[],s=i[2].split("/"),o=0;o<s.length-1;o++){var n=s[o].split(":"),a=n[0],h=n[1],d=h.split("|"),c=d[0],m=d[1],p=d[2];r.push({num:a,x:c,y:m,name:p})}this._main.startGame(r)}else{var l=i[2].split(":"),a=l[0],h=l[1],u=h.split("|"),c=u[0],m=u[1],g=u[2];this._main.columnOpen&&this._main.birdMap.addBird({num:a,x:c,y:m,name:g})}break;case"dead":""!==i[1]?this._main.birdMap.removeBird(i[1],!0):(new TextInput(this._main,i[2],null,240,340,0,220),new TextInput(this._main,i[3],null,240,100,250,220));break;case"oldColumn":if(this._main.columnOpen){var v=new RegExp("oldColumn,(.*),column,(.*)"),f=v.exec(e),x=f[1],y=f[2],w=(this.workForColumnString(x),this.workForColumnString(y));void 0!==this._main.columns&&this._main.columns.push(w)}break;case"position":for(var b=[],_=i[1].split("/"),o=0;o<_.length-1;o++){var E=_[o].split(":"),a=E[0],h=E[1],B=h.split("|"),c=B[0],m=B[1];b.push({num:a,x:c,y:m})}this._main.birdMap.changePosition(b)}},t.prototype.onSocketOpen=function(){var t=Math.floor(400*Math.random()),e=Math.floor(200*Math.random());this.sendMessage("start,"+e+","+t+","+this.name)},t.prototype.sendMessage=function(t){this._socket.writeUTF(t),this._socket.flush()},t}();__reflect(Websocket.prototype,"Websocket");